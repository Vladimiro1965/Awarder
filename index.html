<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Наявність деталей для індивідуального годинника</title>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f0f0f0; }
    h1 { text-align:center; margin:20px 0; }
    .filters { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin:10px 0; }
    .filter-box {
      width:40px; height:40px;
      background:#e0f7fa; border:2px solid #007bff;
      border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; cursor:pointer;
      transition: all 0.3s ease;
    }
    .filter-box:hover { transform:scale(1.1); border-color:#0056b3; }
    .filter-box.constantly { background:#d6f7d6; border-color:#4caf50; }
    .filter-box.missing { background:#ffd6d6; border-color:#f44336; }
    .container { display:flex; gap:20px; max-width:1200px; margin:auto; padding:20px; }
    .left, .right {
      flex:1; background:#fff; border-radius:10px;
      padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
      overflow:auto;
      max-height:calc(100vh - 180px);
    }
    .model-list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .model-item {
      padding:10px; border:1px solid #ccc; border-radius:8px;
      transition:all 0.3s ease; cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .model-item:hover {
      transform:scale(1.02);
      border-color:#007bff;
    }
    .model-item.highlight-positive {
      background:#e6ffe6; border-color:#4dff4d;
    }
    .model-item.highlight-zero {
      background:#ffe6e6; border-color:#ff4d4d;
    }
    .search-box { display:flex; gap:10px; margin-bottom:10px; }
    .search-box input {
      flex:1; padding:8px; border:1px solid #ccc; border-radius:6px;
      font-size:16px;
    }
    .search-box button {
      padding:8px 16px; border:none; border-radius:6px;
      background:#111;color:#fff;cursor:pointer;font-size:16px;
      transition:background 0.3s ease;
    }
    .search-box button:hover { background:#333; }
    #loader,#noResults {
      text-align:center; font-style:italic; margin:10px 0;
      color:#555; display:none;
    }
    #resultsTable {
      width:100%; border-collapse:collapse; margin-top:10px;
    }
    #resultsTable th, #resultsTable td {
      padding:8px; border:1px solid #eee; text-align:center;
      font-size:14px;
    }
    #resultsTable img {
      max-height:50px; transition:transform 0.2s ease;
    }
    #resultsTable img:hover { transform:scale(2); z-index:999; }
    tr.zero-stock { background:#ffe6e6 !important; }
    .total-info { margin-top:10px; text-align:right; font-weight:500; }
  </style>
</head>
<body>
  <h1>Наявність деталей для індивідуального годинника</h1>

  <div class="filters" id="filters"></div>

  <div class="container">
    <div class="left">
      <div class="subtitle">Доступні моделі годинників</div>
      <div class="model-list" id="modelList"></div>
    </div>
    <div class="right">
      <div class="search-box">
        <input type="text" id="watchInput" placeholder="Введіть артикул, напр. 1202-0252">
        <button onclick="searchParts()">Пошук</button>
      </div>
      <div id="loader">Завантаження даних...</div>
      <div id="noResults">Деталі не знайдені.</div>
      <table id="resultsTable" style="display:none;">
        <thead>
          <tr><th>Фото</th><th>Артикул</th><th>Назва</th><th>Прихід</th><th>Розхід</th><th>Залишок</th></tr>
        </thead><tbody></tbody>
      </table>
      <div class="total-info" id="summary"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1VE0UbNuQu0f9BfmkRbKuQpa5xQr9q8XGUKGXmCkxwwI";
    const API_KEY  = "AIzaSyB2l87TIEyJwO1BMDkE_IHMaXG6k2N3rEw";
    const baseURL  = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/`;

    async function fetchSheet(range) {
      const r = await fetch(baseURL + encodeURIComponent(range) + "?key=" + API_KEY);
      const j = await r.json();
      return j.values || [];
    }

    async function loadAvailableModels() {
      const raw = await fetchSheet("Годинники!A:D");
      const [, ...rows] = raw;
      const ml = document.getElementById("modelList");
      ml.innerHTML = "";

      const models = rows.map(r => ({
        id: (r[2] || "").trim(),
        group: (r[2] || "").trim().split("-")[0],
      })).filter(m => /^120[12]-/.test(m.id)); // збережіть умову на групи

      for (const m of models) {
        const div = document.createElement("div");
        div.className = "model-item";
        div.dataset.group = m.group;
        div.dataset.id = m.id;
        div.innerText = `${m.id} — ${m.group}`;
        ml.append(div);
      }

      buildFilters(models);
    }

    function buildFilters(models) {
      const filters = document.getElementById("filters");
      const groups = [...new Set(models.map(m => m.group))].sort();
      filters.innerHTML = "";
      groups.forEach(g => {
        const box = document.createElement("div");
        box.className = "filter-box";
        box.innerText = g;
        box.onclick = () => {
          const ml = document.getElementById("modelList");
          const items = Array.from(ml.querySelectorAll(".model-item"));
          const groupItems = items.filter(i => i.dataset.group === g);
          if (!groupItems.length) return;
          groupItems[0].scrollIntoView({behavior:"smooth", block:"center"});

          groupItems.forEach(i => i.classList.remove("highlight-zero","highlight-positive"));
          // дізнаємося status групи з попередньої пошукової функції
          const isMissing = groupItems.some(i => i.dataset.status === "missing");
          groupItems.forEach(i => i.classList.add(isMissing ? "highlight-zero":"highlight-positive"));
        };
        filters.append(box);
      });
    }

    async function searchParts() {
      const input = document.getElementById("watchInput").value.trim();
      const loader = document.getElementById("loader");
      const noR = document.getElementById("noResults");
      const table = document.getElementById("resultsTable");
      const tbody = table.querySelector("tbody");
      const summaryDiv = document.getElementById("summary");

      loader.style.display = "block";
      noR.style.display = "none";
      table.style.display = "none";
      summaryDiv.innerText = "";

      const rawLink = await fetchSheet("Комплектації!A:D");
      const linkRows = rawLink.slice(1).filter(r => (r[1]||"").trim() === input);
      const articleIds = linkRows.map(r => (r[3]||"").trim());
      if (!articleIds.length) {
        loader.style.display = "none";
        noR.style.display = "block";
        return;
      }

      const rawDet = await fetchSheet("Деталі!A:F");
      const detData = rawDet.slice(1);
      const rawStock = await fetchSheet("Залишки!A:G");
      const stockData = rawStock.slice(1);

      let totalStock = 0;
      tbody.innerHTML = "";

      const modelListItems = Array.from(document.querySelectorAll(".model-item"));
      modelListItems.forEach(i => delete i.dataset.status);

      for (const art of articleIds) {
        const det = detData.find(r => (r[1]||"").trim()==art) || [];
        const name = (det[2] || "").trim() || "Без назви";
        const stockQty = parseInt((det[5]||"0").trim(),10) || 0;
        totalStock += stockQty;

        const rowClass = stockQty === 0 ? "zero-stock" : "";
        tbody.innerHTML += `<tr class="${rowClass}">
          <td><img src="https://abertime.com.ua/image/data/price_google/all_price/big/SK-${art}.jpg" alt="photo" onclick="window.open(this.src)"></td>
          <td>${art}</td><td>${name}</td>
          <td>${(det[3]||"").trim()}</td><td>${(det[4]||"").trim()}</td><td>${(det[5]||"").trim()}</td>
        </tr>`;

        // позначаємо status для квадратиків
        modelListItems.forEach(i => {
          if (i.dataset.id === input) {
            const status = stockQty === 0 ? "missing" : "ok";
            i.dataset.status = status;
          }
        });
      }

      loader.style.display = "none";
      table.style.display = "table";
      summaryDiv.innerText = `Загальна кількість: ${articleIds.length} | Сумарний залишок: ${totalStock} од.`;
    }

    document.getElementById("watchInput").addEventListener("keydown", e => {
      if (e.key === "Enter") searchParts();
    });

    window.onload = loadAvailableModels;
  </script>
</body>
</html>
